<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VOXIN Â· æµ…è‰²ç‰ˆï¼ˆJitter å®æ—¶ç‰ˆ Â· è¿ç»­æ³¢å½¢ï¼‰</title>
  <style>
    :root{
      --bg:#ffffff;          /* é¡µé¢èƒŒæ™¯ */
      --card:#f8fafc;        /* å¡ç‰‡èƒŒæ™¯ */
      --soft:#e5e7eb;        /* æŸ”å’Œåˆ†éš”çº¿ */
      --text:#0f172a;        /* ä¸»æ–‡å­— */
      --muted:#475569;       /* æ¬¡çº§æ–‡å­— */
      --accent:#2563eb;      /* ä¸»æŒ‰é’®/é«˜äº® */
      --accent2:#06b6d4;     /* é¢‘è°±è‰² */
      --danger:#ef4444;      /* å±é™©è‰² */
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:8px 0 6px}
    .sub{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--soft);border-radius:16px;box-shadow:0 2px 14px rgba(15,23,42,.06);padding:12px;overflow: hidden;}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button,select,input[type=range]{appearance:none;border:none}
    button{padding:10px 14px;border-radius:12px;color:#fff;background:var(--accent);font-weight:600;cursor:pointer}
    button.secondary{background:#e2e8f0;color:#0f172a}
    button.danger{background:var(--danger);color:#fff}
    button.ghost{background:transparent;color:var(--muted);border:1px solid var(--soft)}
    button:disabled{opacity:.6}
    select{padding:10px;border-radius:10px;background:#f1f5f9;color:#0f172a;border:1px solid var(--soft)}
    label{font-size:13px;color:var(--muted)}
    .slider{width:100%}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .hint{font-size:12px;color:#64748b}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2f7;border:1px solid #d1d5db;color:#0f172a}
    canvas{display:block;width:100%;height:200px;border-radius:12px;background:#f1f5f9;border:1px solid var(--soft)}
    .badge{font-size:12px;color:#334155}
    .footer{font-size:12px;color:#64748b;text-align:center;margin-top:16px}
    @media (min-width:720px){canvas{height:260px}}
    /* ç„¦ç‚¹å¯è§æ€§ */
    button:focus,select:focus,input:focus{outline:3px solid rgba(37,99,235,.35);outline-offset:2px}

    /* â€”â€” å¼¹çª— â€”â€” */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal[aria-hidden="false"]{display:flex}
    .modal-card{width:100%;max-width:460px;background:var(--card);border:1px solid var(--soft);border-radius:16px;box-shadow:0 10px 30px rgba(15,23,42,.2);padding:16px}
    .modal-card h3{margin:4px 0 6px;font-size:18px}
    .modal-card p{margin:0 0 10px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>VOXIN - å¼€å¯ä½ çš„å£°éŸ³è®­ç»ƒä¹‹æ—…å§ï¼ğŸ¤âœ¨ğŸš€</h1>
      <div class="sub">
        <span id="supportHint" class="hint" style="display:block;margin-top:4px"></span>
      </div>
    </header>

    <section class="card" id="displayCard">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <span class="badge" id="sr">é‡‡æ ·ç‡: â€”</span>
        <span class="pill" id="peak">jitter_local_percent: â€”</span>
      </div>
      <!-- ç”¨ Jitter æ›²çº¿æ›¿ä»£åŸå§‹æ³¢å½¢ï¼ˆè¿ç»­æ¨¡å¼ï¼šé™éŸ³ä¹Ÿç¼“æ…¢æ»‘åŠ¨ï¼‰ -->
      <canvas id="jitter" aria-label="Jitter(%) å®æ—¶æ›²çº¿"></canvas>
      <div style="height:10px"></div>
      <canvas id="spectrum" aria-label="é¢‘è°±å›¾"></canvas>
    </section>

    <section class="grid" style="margin-top:12px">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="toggle">å¼€å§‹</button>
            <button class="secondary" id="reenum">åˆ·æ–°è®¾å¤‡</button>
          </div>
          <div class="badge" id="ctxState"></div>
        </div>

        <div style="height:8px"></div>
        <div class="row">
          <label for="mics">éº¦å…‹é£</label>
          <select id="mics"></select>
        </div>

        <div class="row" style="gap:16px;margin-top:8px">
          <div style="flex:1;min-width:140px">
            <label>å¹³æ»‘ (smoothing) <span id="smoothingVal" class="badge">0.50</span></label>
            <input class="slider" id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.5" />
          </div>
          <div style="flex:1;min-width:140px">
            <label>å¢ç›Š (gain) <span id="gainVal" class="badge">1.0</span></label>
            <input class="slider" id="gain" type="range" min="0.1" max="3" step="0.1" value="1" />
          </div>
          <!-- æ§åˆ¶ â€œJitter è§†çª—ä¸Šé™(%)â€ï¼Œé»˜è®¤ 10% -->
          <div style="flex:1;min-width:140px">
            <label>Jitter è§†çª—ä¸Šé™ (%) <span id="scopeVal" class="badge">10.00%</span></label>
            <input class="slider" id="scope" type="range" min="5" max="20" step="0.5" value="10" />
          </div>
        </div>
      </div>
    </section>

    <div class="footer">Â© <span id="year"></span> VOXIN Demo</div>
  </div>

  <!-- ç»“æœå¼¹çª—ï¼šä¸‹è½½ / ä¸Šä¼  -->
  <div class="modal" id="resultModal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-card">
      <h3 id="modalTitle">å½•éŸ³å®Œæˆ âœ…</h3>
      <div style="margin:10px 0">
        <label for="filenameInput" class="hint">è¯·è¾“å…¥æ–‡ä»¶å(ä¾‹å¦‚ï¼šjack_pre, jack_post)</label>
        <input type="text" id="filenameInput" placeholder="æ–‡ä»¶å" style="width:100%;padding:8px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;margin-top:4px" />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="secondary" id="btnUpload">ä¸Šä¼ </button>
        <button id="btnDownload">ä¸‹è½½</button>
      </div>
      <div id="uploadStatus" class="hint" style="margin-top:8px"></div>
    </div>
  </div>

<script>
(function(){
  // ===== Polyfill: æ—§ç‰ˆæµè§ˆå™¨çš„ getUserMedia è¯•æ¢ =====
  (function ensureGetUserMedia(){
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => { console.log("éº¦å…‹é£é‡‡é›†æˆåŠŸ", stream); })
        .catch(err => { console.error("éº¦å…‹é£é‡‡é›†å¤±è´¥:", err); });
    } else {
      console.error("è¯¥æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£é‡‡é›†");
    }
  })();

  const dpr = window.devicePixelRatio || 1;
  const jitterCanvas = document.getElementById('jitter');
  const spec = document.getElementById('spectrum');
  const toggleBtn = document.getElementById('toggle');
  const reenumBtn = document.getElementById('reenum');
  const micsSel = document.getElementById('mics');
  const smoothingInp = document.getElementById('smoothing');
  const gainInp = document.getElementById('gain');
  const smoothingVal = document.getElementById('smoothingVal');
  const gainVal = document.getElementById('gainVal');
  const scopeInp = document.getElementById('scope');
  const scopeVal = document.getElementById('scopeVal');
  const srEl = document.getElementById('sr');
  const peakEl = document.getElementById('peak'); // å¤ç”¨ä¸º jitter æ˜¾ç¤º
  const ctxState = document.getElementById('ctxState');
  const yearEl = document.getElementById('year');
  const supportHint = document.getElementById('supportHint');
  yearEl.textContent = new Date().getFullYear();

  // â€”â€” å¼¹çª—å…ƒç´  â€”â€” 
  const modal = document.getElementById('resultModal');
  const btnDownload = document.getElementById('btnDownload');
  const btnUpload = document.getElementById('btnUpload');
  const uploadStatus = document.getElementById('uploadStatus');
  const filenameInput = document.getElementById('filenameInput');

  // â€”â€” å½•éŸ³å™¨ & éŸ³é¢‘èŠ‚ç‚¹ â€”â€” 
  let mediaRecorder = null;
  let lastRecording = null; // { blob, mime, filename }

  let ac = null, analyser = null, gainNode = null, src = null, stream = null, raf = null;

  // â€”â€” é¢‘è°±ä¿ç•™ï¼ˆå³°å€¼ç¼“é™ï¼Œé™éŸ³ä¹Ÿä¿æŒé¡ºæ»‘ï¼‰â€”â€”
  let specHold = null; // Uint8Array

  // â€”â€” Jitter çŠ¶æ€ â€”â€” 
  let prevPeriodSec = null;             // ä¸Šä¸€ä¼°è®¡å‘¨æœŸï¼ˆç§’ï¼‰
  let jitterHistory = [];               // å†å²ï¼ˆç™¾åˆ†æ¯”å€¼ï¼‰
  const JITTER_HISTORY_LEN = 600;       // ~10s è½¨è¿¹ï¼ˆ60FPS è¿‘ä¼¼ï¼‰

  // â€”â€” é™éŸ³æ£€æµ‹ & è¿ç»­ç»˜åˆ¶å‚æ•° â€”â€”
  function rms(arr){ let s=0; for(let i=0;i<arr.length;i++) s+=arr[i]*arr[i]; return Math.sqrt(s/arr.length); }
  const SILENCE_RMS = 0.01;      // çº¦ -40dBï¼ŒæŒ‰è®¾å¤‡å¯è°ƒ 0.005~0.02
  const JITTER_DECAY = 0.94;     // é™éŸ³æ—¶å‘ 0% è¡°å‡ç³»æ•°ï¼ˆ0.9 æ›´å¿«ï¼Œ0.98 æ›´æ…¢ï¼‰
  const JITTER_STEP  = 0.02;     // æ¯å¸§åŸºç¡€ä¸‹æ‹‰ï¼ˆ%ï¼‰
  const JITTER_FLOOR_NOISE = 0.03; // åœ°æ¿éšæœºæŠ–åŠ¨ä¸Šé™ï¼ˆ%ï¼‰

  // åŸºç¡€ç¯å¢ƒæç¤º
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if (!isSecure) {
    supportHint.textContent = 'âš ï¸ éå®‰å…¨ç¯å¢ƒï¼šè¯·ä½¿ç”¨ HTTPS æˆ– localhostã€‚';
  }

  function resizeCanvas(c){
    const rect = c.parentElement ? c.parentElement.getBoundingClientRect() : {width: c.clientWidth};
    const cssW = Math.floor(rect.width);
    const cssH = Math.max(160, Math.floor(cssW * 0.4));
    c.style.height = cssH + 'px';
    c.width  = Math.floor(cssW * dpr);
    c.height = Math.floor(cssH * dpr);
  }

  const onResize = ()=>{resizeCanvas(jitterCanvas); resizeCanvas(spec)};
  window.addEventListener('resize', onResize);
  onResize();

  async function enumerate(){
    if (!(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices)) {
      micsSel.innerHTML = '<option value="">é»˜è®¤éº¦å…‹é£ï¼ˆè®¾å¤‡åˆ‡æ¢ä¸å¯ç”¨ï¼‰</option>';
      return;
    }
    try{
      const tmp = await navigator.mediaDevices.getUserMedia({audio:true});
      tmp.getTracks().forEach(t=>t.stop());
      const list = await navigator.mediaDevices.enumerateDevices();
      const mics = list.filter(d=>d.kind==='audioinput');
      const opts = mics.map((d,i)=>`<option value="${d.deviceId||''}">${d.label||`éº¦å…‹é£ ${i+1}`}</option>`).join('');
      micsSel.innerHTML = opts || '<option value="">é»˜è®¤éº¦å…‹é£ï¼ˆæœªåˆ—å‡ºè®¾å¤‡ï¼‰</option>';
    }catch(e){
      micsSel.innerHTML='<option value="">é»˜è®¤éº¦å…‹é£</option>';
    }
  }
  enumerate();

  function getTimestamp() {
    const d = new Date();
    const pad = n => n.toString().padStart(2, '0');
    return [d.getFullYear(),pad(d.getMonth()+1),pad(d.getDate()),pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join('_');
  }

  async function start(){
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæˆ–æœªå¯ç”¨éº¦å…‹é£é‡‡é›†ï¼ˆç¼ºå°‘ navigator.mediaDevices.getUserMediaï¼‰ã€‚è¯·å‡çº§ç³»ç»Ÿ/æµè§ˆå™¨ï¼Œæˆ–æ”¹ç”¨ Safari/ç³»ç»Ÿæµè§ˆå™¨ã€‚');
      return;
    }

    toggleBtn.disabled = true;
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) { throw new Error('æ­¤æµè§ˆå™¨ä¸æ”¯æŒ Web Audio APIï¼ˆç¼ºå°‘ AudioContextï¼‰ã€‚'); }

      ac = new AudioCtx();
      if(ac.state==='suspended') await ac.resume();
      ctxState.textContent=ac.state;
      ac.onstatechange = (e) => { if (ctxState && e && e.target) ctxState.textContent = e.target.state; };

      const baseConstraints = { audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:false } };
      let constraints = baseConstraints;
      const canSelectDevice = !!(micsSel && micsSel.value && micsSel.value !== '');
      if (canSelectDevice) {
        constraints = { audio: { deviceId: { exact: micsSel.value }, echoCancellation:true, noiseSuppression:true, autoGainControl:false } };
      }

      try { stream = await navigator.mediaDevices.getUserMedia(constraints); }
      catch (err) { stream = await navigator.mediaDevices.getUserMedia({ audio: true }); }

      src = ac.createMediaStreamSource(stream);
      analyser = ac.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = parseFloat(smoothingInp.value);

      gainNode = ac.createGain();
      gainNode.gain.value = parseFloat(gainInp.value);

      src.connect(gainNode).connect(analyser);

      srEl.textContent = 'é‡‡æ ·ç‡: ' + ac.sampleRate + ' Hz';

      // åˆå§‹åŒ– Jitter & é¢‘è°±ç¼“é™
      prevPeriodSec = null;
      jitterHistory = [];
      peakEl.textContent = 'jitter_local_percent: â€”';
      specHold = new Uint8Array(analyser.frequencyBinCount);

      // å¼€å§‹ç»˜åˆ¶
      raf = requestAnimationFrame(draw);
      toggleBtn.textContent = 'åœæ­¢';

      // å½•éŸ³èƒ½åŠ›
      if ('MediaRecorder' in window) {
        let chunks = [];
        try{
          mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' }, { bitsPerSecond: 128000 });
          chunks = [];
          mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
          mediaRecorder.onstop = () => {
            if (!chunks.length) { showModal(); return; }
            const mime = mediaRecorder.mimeType || 'audio/webm';
            const blob = new Blob(chunks, {type: mime});
            const ts = new Date().toISOString().replace(/[:.]/g,'-');
            const filename = `record-${ts}.${mime.includes('webm') ? 'webm' : mime.split('/')[1] || 'dat'}`;
            lastRecording = { blob, mime, filename };
            showModal();
          };
          mediaRecorder.start();
        }catch(err){ alert('å½•éŸ³å¯åŠ¨å¤±è´¥ï¼š' + (err.message || err)); }
      } else {
        console.log('å½“å‰ç¯å¢ƒä¸æ”¯æŒ MediaRecorderï¼ˆiOS è€ç‰ˆæœ¬å¸¸è§ï¼‰');
      }

    }catch(e){
      alert((e && e.message) ? e.message : 'å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœªæˆæƒéº¦å…‹é£ã€é HTTPSã€æˆ–æµè§ˆå™¨ä¸å…¼å®¹ã€‚');
      stop();
    }finally{
      toggleBtn.disabled = false;
    }
  }

  async function stop(){
    cancelAnimationFrame(raf); raf = null;
    try{ if (gainNode) gainNode.disconnect(); }catch(_){ }
    try{ if (analyser) analyser.disconnect(); }catch(_){ }
    try{ if (src) src.disconnect(); }catch(_){ }
    try{ if (stream){ stream.getTracks().forEach(t=>t.stop()); } }catch(_){ }
    try{ if (ac){ ac.onstatechange = null; await ac.close(); } }catch(_){ }

    ac = null; analyser = null; gainNode = null; src = null; stream = null;

    ctxState.textContent='';
    toggleBtn.textContent='å¼€å§‹';

    // åœæ­¢å½•éŸ³ï¼šè§¦å‘ MediaRecorder.onstopï¼Œä»è€Œå¼¹å‡ºæ“ä½œå¼¹çª—
    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
      mediaRecorder.stop();
    } else {
      showModal();
    }

    // é‡ç½®æ˜¾ç¤º
    prevPeriodSec = null;
    jitterHistory = [];
    peakEl.textContent = 'jitter_local_percent: â€”';
  }

  // â€”â€” å¼¹çª—é€»è¾‘ â€”â€” 
  function showModal(){
    modal.setAttribute('aria-hidden','false');
    uploadStatus.textContent = '';
    btnDownload.disabled = !lastRecording;
  }
  function hideModal(){ modal.setAttribute('aria-hidden','true'); }

  // ä¸‹è½½å½“å‰å½•éŸ³
  btnDownload.addEventListener('click', () => {
    if (!lastRecording) { alert('æ²¡æœ‰å¯ä¸‹è½½çš„å½•éŸ³ã€‚'); return; }
    if (!filenameInput.value.trim()) { alert('è¯·è¾“å…¥æ–‡ä»¶åã€‚'); return; }
    const input_filename = `${filenameInput.value.trim()}_${getTimestamp()}.webm`;

    const { blob } = lastRecording;
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = input_filename;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  });

  // ä¸Šä¼ å½“å‰å½•éŸ³ï¼ˆè¯·æ›¿æ¢ä¸ºä½ çš„ä¸Šä¼ æ¥å£ï¼‰
  btnUpload.addEventListener('click', async () => {
    try{
      if (!lastRecording) { alert('æ²¡æœ‰å¯ä¸Šä¼ çš„å½•éŸ³ã€‚'); return; }
      if (!filenameInput.value.trim()) { alert('è¯·è¾“å…¥æ–‡ä»¶åã€‚'); return; }
      const input_filename = `${filenameInput.value.trim()}_${getTimestamp()}.webm`;

      uploadStatus.textContent = 'æ­£åœ¨ä¸Šä¼ â€¦';
      const ENDPOINT = 'https://43.136.55.43/api/upload';
      const { blob, mime } = lastRecording;
      const fd = new FormData();
      fd.append('file', blob, input_filename);
      fd.append('mime', mime);
      const res = await fetch(ENDPOINT, { method:'POST', body: fd });
      if (!res.ok) throw new Error('ä¸Šä¼ å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š' + res.status);
      const text = await res.text().catch(()=> '');
      console.log('ä¸Šä¼ å“åº”:', text);
      uploadStatus.textContent = 'ä¸Šä¼ æˆåŠŸï¼';
    }catch(err){
      uploadStatus.textContent = 'ä¸Šä¼ å¤±è´¥ï¼š' + (err && err.message ? err.message : err);
    }
  });

  modal.addEventListener('click', (e)=>{ if(e.target===modal) hideModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') hideModal(); });

  toggleBtn.addEventListener('click',()=>{ if(ac) stop(); else start(); });
  reenumBtn.addEventListener('click',enumerate);

  smoothingInp.addEventListener('input',()=>{
    const v = parseFloat(smoothingInp.value);
    smoothingVal.textContent = v.toFixed(2);
    if(analyser) analyser.smoothingTimeConstant = v;
  });
  gainInp.addEventListener('input',()=>{
    const v = parseFloat(gainInp.value);
    gainVal.textContent = v.toFixed(1);
    if(gainNode) gainNode.gain.value = v;
  });
  scopeInp && scopeInp.addEventListener('input', () => {
    const v = parseFloat(scopeInp.value);
    scopeVal.textContent = v.toFixed(2) + '%';
  });

  // ====== å®æ—¶ Jitter è®¡ç®—ä¸ç»˜åˆ¶ï¼ˆè¿ç»­æ¨¡å¼ï¼‰======

  function hannWindow(arr){
    const N = arr.length;
    for (let i=0;i<N;i++){
      arr[i] *= 0.5 * (1 - Math.cos(2*Math.PI*i/(N-1)));
    }
  }

  // ä¼°è®¡å•å¸§åŸºé¢‘å‘¨æœŸï¼ˆç§’ï¼‰ï¼›è¿”å› null è¡¨ç¤ºæ— æ•ˆ
  function estimatePeriodSec(frame, sr, fmin=60, fmax=400){
    // å»ç›´æµ
    let mean = 0; for (let i=0;i<frame.length;i++) mean += frame[i]; mean /= frame.length;
    for (let i=0;i<frame.length;i++) frame[i] -= mean;

    // å½’ä¸€åŒ–
    let maxAbs = 1e-12;
    for (let i=0;i<frame.length;i++){ const a = Math.abs(frame[i]); if (a>maxAbs) maxAbs = a; }
    if (maxAbs < 1e-6) return null;
    for (let i=0;i<frame.length;i++) frame[i] /= maxAbs;

    // ä¸­å¿ƒè£å‰ªï¼ˆæŠ‘åˆ¶å°å¹…å™ªå£°çš„å‡å³°ï¼‰
    const clip = 0.2; // 0~1ï¼Œè¶Šå¤§è¶Šâ€œç¡¬â€
    for (let i=0;i<frame.length;i++){
      const x = frame[i];
      frame[i] = Math.abs(x) < clip ? 0 : (x > 0 ? x-clip : x+clip);
    }

    // åŠ çª—
    hannWindow(frame);

    // ç›´æ¥è‡ªç›¸å…³ï¼ˆN^2ï¼‰ï¼Œ2048 ç‚¹å¼€é”€å¯æ¥å—
    const N = frame.length;
    const acf = new Float32Array(N);
    for (let lag=0; lag<N; lag++){
      let s = 0; for (let i=0; i<N-lag; i++) s += frame[i]*frame[i+lag];
      acf[lag] = s;
    }

    // åœ¨ [lagMin, lagMax] æœå³°
    const lagMin = Math.floor(sr / fmax);
    const lagMax = Math.min(N-1, Math.ceil(sr / fmin));
    if (lagMax - lagMin < 4) return null;

    let bestLag = -1, bestVal = -Infinity;
    for (let lag=lagMin; lag<=lagMax; lag++){
      const v = acf[lag];
      if (v > bestVal){ bestVal = v; bestLag = lag; }
    }
    if (bestLag <= 0) return null;

    // æŠ›ç‰©çº¿æ’å€¼ç»†åŒ–
    const l = bestLag-1, r = bestLag+1;
    if (l>=0 && r<N){
      const yl = acf[l], y0 = acf[bestLag], yr = acf[r];
      const denom = (yl - 2*y0 + yr);
      if (Math.abs(denom) > 1e-9){
        const delta = 0.5 * (yl - yr) / denom;
        bestLag = bestLag + delta; // å…è®¸å°æ•°æ»å
      }
    }
    const periodSec = bestLag / sr;
    if (periodSec < 1/fmax || periodSec > 1/fmin) return null;
    return periodSec;
  }

  // Praat æœ¬åœ°æŠ–åŠ¨è¿‘ä¼¼ï¼š|T_i - T_{i-1}| / mean(T_i, T_{i-1})
  function computeLocalJitterPercent(currT, prevT, maxPeriodFactor=1.3){
    if (prevT == null) return null;
    const meanT = 0.5 * (currT + prevT);
    if (meanT <= 0) return null;
    const ratio = currT > prevT ? (currT/prevT) : (prevT/currT);
    if (ratio > maxPeriodFactor) return null; // æ’é™¤è¿‡å¤§è·³å˜
    const frac = Math.abs(currT - prevT) / meanT;
    return frac * 100.0;
  }

  function draw(){
    if (!analyser || !ac){ raf = requestAnimationFrame(draw); return; }

    const sctx = spec.getContext('2d');
    const jctx = jitterCanvas.getContext('2d');
    const SW = spec.width, SH = spec.height;
    const JW = jitterCanvas.width, JH = jitterCanvas.height;

    // ===== 1) ä» analyser æŠ½æ ·ä¸€å¸§ PCMï¼Œä¼°è®¡èƒ½é‡ =====
    const td = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(td);
    const level = rms(td);
    const isSilent = level < SILENCE_RMS;

    // ===== 2) é¢‘è°±ï¼ˆå³°å€¼ç¼“é™ï¼‰ =====
    const fd = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(fd);
    if (!specHold || specHold.length !== fd.length) specHold = new Uint8Array(fd.length);
    // ç¼“é™ï¼šä¿æŒä¸Šä¸€å¸§æ›´å¤§å€¼ï¼Œå‘ä¸‹æŒ‰ 0.96 è¡°å‡
    for (let i=0;i<fd.length;i++){
      const decayed = Math.floor(specHold[i] * 0.96);
      specHold[i] = Math.max(fd[i], decayed);
    }
    sctx.clearRect(0,0,SW,SH);
    sctx.fillStyle = '#ffffff'; sctx.fillRect(0,0,SW,SH);
    const bw = Math.max(1, Math.floor(SW / specHold.length));
    sctx.fillStyle = '#06b6d4';
    for (let i = 0; i < specHold.length; i++) {
      const v = specHold[i] / 255;
      const h = v * SH;
      sctx.fillRect(i * bw, SH - h, bw - 1, h);
    }

    // ===== 3) Jitter è¿ç»­æ›²çº¿ï¼šæœ‰å£°ä¼°è®¡ / é™éŸ³å¹³æ»‘æ»‘è¡Œ =====
    let currJ = null;
    if (!isSilent){
      const currPeriodSec = estimatePeriodSec(td.slice(), ac.sampleRate, 60, 400);
      if (currPeriodSec != null){
        const j = computeLocalJitterPercent(currPeriodSec, prevPeriodSec, 1.3);
        if (j != null){
          jitterHistory.push(j);
          if (jitterHistory.length > JITTER_HISTORY_LEN) jitterHistory.shift();
          currJ = j;
        }
        prevPeriodSec = currPeriodSec;
      }
    } else {
      // é™éŸ³ï¼šä¸åšå‘¨æœŸä¼°è®¡ï¼›æ›²çº¿å‘ 0% ç¼“æ…¢å›è½å¹¶ç»´æŒè½»å¾®æŠ–åŠ¨
      prevPeriodSec = null;
      let last = jitterHistory.length ? jitterHistory[jitterHistory.length-1] : 0;
      let next = Math.max(0, last * JITTER_DECAY - JITTER_STEP);
      next += Math.random() * JITTER_FLOOR_NOISE; // 0~0.03% ç»†å¾®æŠ–åŠ¨
      jitterHistory.push(next);
      if (jitterHistory.length > JITTER_HISTORY_LEN) jitterHistory.shift();
    }

    // ç”» Jitter èƒŒæ™¯ç½‘æ ¼
    jctx.clearRect(0,0,JW,JH);
    jctx.fillStyle = '#ffffff'; jctx.fillRect(0,0,JW,JH);
    const maxView = parseFloat(scopeInp ? scopeInp.value : 10);
    jctx.strokeStyle = '#cbd5e1';
    jctx.lineWidth = Math.max(1, dpr);
    const refPerc = [0, 1, 2, 5, 10].filter(p=>p<=maxView);
    refPerc.forEach(p=>{
      const y = JH - (p/maxView) * JH;
      if (y>=0 && y<=JH){ jctx.beginPath(); jctx.moveTo(0, y); jctx.lineTo(JW, y); jctx.stroke(); }
    });

    // ç”» Jitter æ›²çº¿
    if (jitterHistory.length > 1){
      jctx.beginPath();
      jctx.strokeStyle = '#2563eb';
      const n = jitterHistory.length;
      for (let i=0;i<n;i++){
        const x = Math.round((i/(n-1)) * (JW-1));
        const val = Math.min(jitterHistory[i], maxView);
        const y = Math.round(JH - (val/maxView) * (JH-1));
        if (i===0) jctx.moveTo(x,y); else jctx.lineTo(x,y);
      }
      jctx.stroke();
    }

    // æ•°å€¼æ˜¾ç¤º
    if (!isSilent && currJ != null){
      peakEl.textContent = 'jitter_local_percent: ' + currJ.toFixed(2) + '%';
    } else if (isSilent){
      const val = jitterHistory.length ? jitterHistory.at(-1) : 0;
      peakEl.textContent = 'jitter_local_percent: ~' + val.toFixed(2) + '%ï¼ˆé™éŸ³ï¼‰';
    } else {
      if (!jitterHistory.length) peakEl.textContent = 'jitter_local_percent: â€”';
    }

    raf = requestAnimationFrame(draw);
  }

})();
</script>
</body>
</html>
