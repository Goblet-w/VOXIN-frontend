<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VOXIN</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2b;--soft:#1f2a44;--text:#e5e7eb;--muted:#9ca3af;--accent:#60a5fa;--accent2:#22d3ee;--danger:#fb7185}
    *{box-sizing:border-box} html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{max-width:760px;margin:0 auto;padding:16px}
    h1{font-size:22px;margin:8px 0 6px}
    .sub{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid #0e172a;border-radius:16px;box-shadow:0 2px 14px rgba(0,0,0,.2);padding:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    button,select,input[type=range]{appearance:none;border:none}
    button{padding:10px 14px;border-radius:12px;color:#0b1220;background:var(--accent);font-weight:600}
    button.secondary{background:#334155;color:#e2e8f0}
    button.danger{background:var(--danger);color:#fff}
    button:disabled{opacity:.6}
    select{padding:10px;border-radius:10px;background:#1f2937;color:#e5e7eb}
    label{font-size:13px;color:var(--muted)}
    .slider{width:100%}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .hint{font-size:12px;color:#93a3b8}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border-radius:999px;background:#0f172a;border:1px solid #0b284a}
    canvas{display:block;width:100%;height:200px;border-radius:12px;background:#0a1221}
    .badge{font-size:12px;color:#cbd5e1}
    .footer{font-size:12px;color:#94a3b8;text-align:center;margin-top:16px}
    @media (min-width:720px){canvas{height:260px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>VOXIN - å¼€å¯ä½ çš„å£°éŸ³è®­ç»ƒä¹‹æ—…å§ï¼ğŸ¤âœ¨ğŸš€</h1>
      <div class="sub">
        <span id="supportHint" class="hint" style="display:block;margin-top:4px"></span>
      </div>
    </header>

    <section class="card" id="displayCard">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <span class="badge" id="sr">é‡‡æ ·ç‡: â€”</span>
        <span class="pill" id="peak">å³°å€¼: 0%</span>
      </div>
      <canvas id="wave"></canvas>
      <div style="height:10px"></div>
      <canvas id="spectrum" aria-label="é¢‘è°±å›¾"></canvas>
    </section>

    <section class="grid" style="margin-top:12px">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button id="toggle">å¼€å§‹</button>
            <button class="secondary" id="reenum">åˆ·æ–°è®¾å¤‡</button>
          </div>
          <div class="badge" id="ctxState"></div>
        </div>

        <div style="height:8px"></div>
        <div class="row">
          <label for="mics">éº¦å…‹é£</label>
          <select id="mics"></select>
        </div>

        <div class="row" style="gap:16px;margin-top:8px">
          <div style="flex:1;min-width:140px">
            <label>å¹³æ»‘ (smoothing) <span id="smoothingVal" class="badge">0.50</span></label>
            <input class="slider" id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.5" />
          </div>
          <div style="flex:1;min-width:140px">
            <label>å¢ç›Š (gain) <span id="gainVal" class="badge">1.0</span></label>
            <input class="slider" id="gain" type="range" min="0.1" max="3" step="0.1" value="1" />
          </div>
          <!-- æ–°å¢ï¼šä»…å½±å“â€œæ˜¾ç¤ºâ€çš„æ³¢å½¢ç¼©æ”¾ï¼ˆä¸æ”¹å˜éŸ³é¢‘ç®¡çº¿ï¼‰ -->
          <div style="flex:1;min-width:140px">
            <label>æ³¢å½¢ç¼©æ”¾ (scope) <span id="scopeVal" class="badge">1.00Ã—</span></label>
            <input class="slider" id="scope" type="range" min="0.25" max="100" step="0.25" value="50" />
          </div>
        </div>
      </div>

      <div class="card" id="recorderCard">
        <div class="row" style="justify-content:space-between">
          <strong>å½•éŸ³</strong>
        </div>
        <div class="row" style="margin-top:8px;gap:8px">
          <button id="recBtn" class="secondary" disabled>å¼€å§‹å½•éŸ³</button>
          <button id="recStopBtn" class="danger" disabled>åœæ­¢å¹¶ä¿å­˜</button>
          <a id="dl" class="pill" href="#" download style="display:none">ä¸‹è½½</a>
        </div>
        <div id="recHint" class="hint" style="margin-top:6px"></div>
      </div>

      <div class="card">
        <ul class="hint" style="margin:0 0 0 18px">
        </ul>
      </div>
    </section>

    <div class="footer">Â© <span id="year"></span> VOXIN Demo</div>
  </div>

<script>
(function(){
  // ===== Polyfill: æ—§ç‰ˆæµè§ˆå™¨çš„ getUserMedia =====
  (function ensureGetUserMedia(){
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          console.log("éº¦å…‹é£é‡‡é›†æˆåŠŸ", stream);
        })
        .catch(err => {
          console.error("éº¦å…‹é£é‡‡é›†å¤±è´¥:", err);
        });
    } else {
      console.error("è¯¥æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£é‡‡é›†");
    }

  })();

  const dpr = window.devicePixelRatio || 1;
  const wave = document.getElementById('wave');
  const spec = document.getElementById('spectrum');
  const toggleBtn = document.getElementById('toggle');
  const reenumBtn = document.getElementById('reenum');
  const micsSel = document.getElementById('mics');
  const smoothingInp = document.getElementById('smoothing');
  const gainInp = document.getElementById('gain');
  const smoothingVal = document.getElementById('smoothingVal');
  const gainVal = document.getElementById('gainVal');
  const scopeInp = document.getElementById('scope');           // æ–°å¢
  const scopeVal = document.getElementById('scopeVal');         // æ–°å¢
  const srEl = document.getElementById('sr');
  const peakEl = document.getElementById('peak');
  const ctxState = document.getElementById('ctxState');
  const yearEl = document.getElementById('year');
  const supportHint = document.getElementById('supportHint');
  yearEl.textContent = new Date().getFullYear();

  const recBtn = document.getElementById('recBtn');
  const recStopBtn = document.getElementById('recStopBtn');
  const dl = document.getElementById('dl');
  const recHint = document.getElementById('recHint');

  let ac = null, analyser = null, gainNode = null, src = null, stream = null, raf = null;

  // â€”â€” ç¯å½¢ç¼“å†²ï¼ˆå†å²æ³¢å½¢ï¼‰ï¼Œé»˜è®¤ 10 ç§’ â€”â€” å¯æŒ‰éœ€æ”¹çŸ­ä¸º 3~5 ç§’
  let windowSec = 30;
  let ring = null, ringLen = 0, writeIdx = 0, totalWritten = 0, tdFloat = null;

  // åŸºç¡€ç¯å¢ƒæç¤º
  const isSecure = location.protocol === 'https:' || location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  if (!isSecure) {
    supportHint.textContent = 'âš ï¸ éå®‰å…¨ç¯å¢ƒï¼šè¯·ä½¿ç”¨ HTTPS æˆ– localhostã€‚';
  }

  function resizeCanvas(c){
    const parent = c.parentElement; if(!parent) return;
    const w = parent.clientWidth; const h = Math.max(160, Math.floor(w*0.4));
    c.style.width = w+'px'; c.style.height = h+'px';
    c.width = Math.floor(w*dpr); c.height = Math.floor(h*dpr);
  }
  const onResize = ()=>{resizeCanvas(wave); resizeCanvas(spec)};
  window.addEventListener('resize', onResize);
  onResize();

  async function enumerate(){
    // æŸäº›æ—§ç‰ˆ iOS æ²¡æœ‰ enumerateDevicesï¼šç›´æ¥ç»™ä¸€ä¸ªé»˜è®¤é¡¹
    if (!(navigator.mediaDevices && navigator.mediaDevices.enumerateDevices)) {
      micsSel.innerHTML = '<option value="">é»˜è®¤éº¦å…‹é£ï¼ˆè®¾å¤‡åˆ‡æ¢ä¸å¯ç”¨ï¼‰</option>';
      return;
    }
    try{
      // å…ˆè§¦å‘ä¸€æ¬¡æƒé™ä»¥æ‹¿åˆ°è®¾å¤‡æ ‡ç­¾ï¼ˆiOS ä¸‹ä¸ä¸€å®šæœ‰æ•ˆï¼‰
      const tmp = await navigator.mediaDevices.getUserMedia({audio:true});
      tmp.getTracks().forEach(t=>t.stop());
      const list = await navigator.mediaDevices.enumerateDevices();
      const mics = list.filter(d=>d.kind==='audioinput');
      micsSel.innerHTML = '';
      if(mics.length===0){
        const opt=document.createElement('option'); opt.value=''; opt.textContent='é»˜è®¤éº¦å…‹é£ï¼ˆæœªåˆ—å‡ºè®¾å¤‡ï¼‰'; micsSel.appendChild(opt);
      }else{
        mics.forEach((d,i)=>{
          const opt=document.createElement('option'); opt.value=d.deviceId||''; opt.textContent=d.label||`éº¦å…‹é£ ${i+1}`; micsSel.appendChild(opt);
        });
      }
    }catch(e){
      micsSel.innerHTML='<option value="">é»˜è®¤éº¦å…‹é£</option>';
    }
  }
  enumerate();

  async function start(){
    // è¿è¡Œå‰æ£€æŸ¥åŸºæœ¬æ”¯æŒ
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒæˆ–æœªå¯ç”¨éº¦å…‹é£é‡‡é›†ï¼ˆç¼ºå°‘ navigator.mediaDevices.getUserMediaï¼‰ã€‚è¯·å‡çº§ç³»ç»Ÿ/æµè§ˆå™¨ï¼Œæˆ–æ”¹ç”¨ Safari/ç³»ç»Ÿæµè§ˆå™¨ã€‚');
      return;
    }

    toggleBtn.disabled = true;
    try{
      const AudioCtx = window.AudioContext || window.webkitAudioContext;
      if (!AudioCtx) {
        throw new Error('æ­¤æµè§ˆå™¨ä¸æ”¯æŒ Web Audio APIï¼ˆç¼ºå°‘ AudioContextï¼‰ã€‚');
      }

      ac = new AudioCtx();
      if(ac.state==='suspended') await ac.resume();
      ctxState.textContent=ac.state;
      ac.onstatechange = ()=>{ctxState.textContent=ac.state};

      // iOS/æ—§ç‰ˆå¯¹çº¦æŸæ”¯æŒæœ‰é™ï¼šå…ˆä»æœ€ç®€å•çš„ {audio:true} å¼€å§‹ï¼Œå†å°è¯•å¸¦å‚æ•°
      const baseConstraints = { audio: true };
      let constraints = baseConstraints;

      // å¦‚æœç¯å¢ƒæ”¯æŒè®¾å¤‡é€‰æ‹©ï¼ˆå¤šæ•°æ¡Œé¢/å®‰å“ï¼‰ï¼Œå†åŠ  deviceId ä¸å…³é—­å¤„ç†çš„é€‰é¡¹
      const canSelectDevice = !!(micsSel && micsSel.value && micsSel.value !== '');
      if (canSelectDevice) {
        constraints = {
          audio: {
            deviceId: { exact: micsSel.value },
            echoCancellation:false, noiseSuppression:false, autoGainControl:false
          }
        };
      } else {
        // å…³é—­å¤„ç†é¡¹ï¼ˆæ—§ç‰ˆå¯èƒ½å¿½ç•¥ï¼‰
        constraints = { audio: { echoCancellation:false, noiseSuppression:false, autoGainControl:false } };
      }

      // æœ‰äº›æ—§ iOS å¯¹å¸¦çº¦æŸä¸å…¼å®¹ï¼šå¤±è´¥æ—¶é€€å›æœ€æœ´ç´ çš„ {audio:true}
      try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
      } catch (err) {
        stream = await navigator.mediaDevices.getUserMedia(baseConstraints);
      }

      src = ac.createMediaStreamSource(stream);

      analyser = ac.createAnalyser();
      analyser.fftSize = 2048;
      analyser.smoothingTimeConstant = parseFloat(smoothingInp.value);

      gainNode = ac.createGain();
      gainNode.gain.value = parseFloat(gainInp.value);

      src.connect(gainNode).connect(analyser);

      srEl.textContent = 'é‡‡æ ·ç‡: ' + ac.sampleRate + ' Hz';

      // åˆå§‹åŒ–ç¯å½¢ç¼“å†²
      ringLen = Math.ceil(ac.sampleRate * windowSec * 1.2);
      ring = new Float32Array(ringLen);
      writeIdx = 0; totalWritten = 0;
      tdFloat = new Float32Array(analyser.fftSize);
      const fd = new Uint8Array(analyser.frequencyBinCount);

      function draw(){
        const wctx = wave.getContext('2d');
        const sctx = spec.getContext('2d');
        const W = wave.width, H = wave.height, SW = spec.width, SH = spec.height;

        // çº¿å®½è·Ÿéš DPRï¼Œæ›´æ¸…æ™°
        wctx.lineWidth = Math.max(1, dpr);

        // èƒŒæ™¯ä¸ä¸­çº¿
        wctx.clearRect(0,0,W,H);
        wctx.fillStyle = '#0b1220'; wctx.fillRect(0,0,W,H);
        wctx.strokeStyle = '#1f2a44'; wctx.beginPath(); wctx.moveTo(0,H/2); wctx.lineTo(W,H/2); wctx.stroke();

        // æ”¶é›†ä¸€å¸§
        analyser.getFloatTimeDomainData(tdFloat);
        let pk = 0;
        for (let i = 0; i < tdFloat.length; i++) {
          const v = tdFloat[i];
          ring[writeIdx] = v;
          writeIdx = (writeIdx + 1) % ringLen;
          totalWritten++;
          if (Math.abs(v) > pk) pk = Math.abs(v);
        }
        peakEl.textContent = 'å³°å€¼: ' + Math.min(100, Math.round(pk * 100)) + '%';

        // å›ºå®šç›®æ ‡çª—å£ï¼ˆN ç§’ï¼‰å¯¹åº”çš„æ ·æœ¬æ•°
        const targetSamples = Math.floor(ac.sampleRate * windowSec);
        // ç›®å‰å®é™…å¯ç”¨çš„æ ·æœ¬æ•°
        const available = Math.min(totalWritten, targetSamples);

        // åˆ—å®½åŸºäºâ€œç›®æ ‡çª—å£â€è€Œéâ€œç›®å‰å¯ç”¨â€â€”â€”è¿™æ ·çª—å£æ„Ÿç¨³å®š
        const stride = Math.max(1, Math.floor(targetSamples / W));

        // ä»ç¯å½¢ç¼“å†²ä¸­ï¼Œæˆªå–â€œæœ€å available ä¸ªæ ·æœ¬â€ä½œä¸ºå¯è§æ•°æ®
        let startIdx = (writeIdx - available + ringLen) % ringLen;

        // è®¡ç®—æŠŠå¯è§æ•°æ®â€œå³å¯¹é½â€åçš„èµ·ç»˜åˆ—ï¼šå·¦ä¾§ç©ºç™½ç›´åˆ° offsetX-1
        const visibleCols = Math.max(1, Math.floor(available / stride));
        const offsetX = W - visibleCols;

        // æ˜¾ç¤ºç¼©æ”¾ï¼ˆä»…å½±å“å¯è§†åŒ–ï¼‰
        const scope = scopeInp ? parseFloat(scopeInp.value) : 1;

        wctx.strokeStyle = '#60a5fa';
        wctx.beginPath();

        // å…ˆæŠŠå·¦ä¾§ç©ºç™½åŒºæ¸…æ‰ï¼ˆå¯é€‰ï¼Œé€šå¸¸å‰é¢æ¸…å…¨å±å·²è¶³å¤Ÿï¼‰
        /*
        wctx.clearRect(0, 0, offsetX, H);
        wctx.fillStyle = '#0b1220';
        wctx.fillRect(0, 0, offsetX, H);
        */

        // åªåœ¨ [offsetX, W) èŒƒå›´å†…ç»˜åˆ¶çœŸå®æ•°æ®åˆ—ï¼Œå³ä¾§è´´è¾¹ï¼Œè§†è§‰ä¸Šå°±æ˜¯ä»å³å‘å·¦æ¨è¿›
        for (let x = offsetX; x < W; x++) {
          let min =  1, max = -1;
          // å–è¿™ä¸€åˆ—å¯¹åº”çš„è‹¥å¹²æ ·æœ¬ï¼Œæ±‚ min/maxï¼ˆç«–æ¡ï¼‰
          for (let k = 0; k < stride; k++) {
            // æ³¨æ„åˆ—åˆ°æ ·æœ¬çš„æ˜ å°„ä» â€œstartIdx + (x - offsetX) * strideâ€ å¼€å§‹
            const idx = (startIdx + (x - offsetX) * stride + k) % ringLen;
            let v = ring[idx] * scope;         // å¯è§†ç¼©æ”¾
            if (v >  1) v =  1;                // å¤¹ç´§ï¼Œé¿å…è¶Šç•Œ
            if (v < -1) v = -1;
            if (v < min) min = v;
            if (v > max) max = v;
          }
          const y1 = (1 - (max + 1) / 2) * H;
          const y2 = (1 - (min + 1) / 2) * H;
          wctx.moveTo(x, y1);
          wctx.lineTo(x, y2);
        }
        wctx.stroke();


        // é¢‘è°±ï¼ˆç¬æ—¶ï¼‰
        analyser.getByteFrequencyData(fd);
        sctx.clearRect(0,0,SW,SH);
        sctx.fillStyle = '#0b1220'; sctx.fillRect(0,0,SW,SH);
        const bw = Math.max(1, Math.floor(SW / fd.length));
        sctx.fillStyle = '#22d3ee';
        for (let i = 0; i < fd.length; i++) {
          const v = fd[i] / 255;
          const h = v * SH;
          sctx.fillRect(i * bw, SH - h, bw - 1, h);
        }

        raf = requestAnimationFrame(draw);
      }

      raf = requestAnimationFrame(draw);
      toggleBtn.textContent = 'åœæ­¢';

      // å½•éŸ³èƒ½åŠ›æ£€æµ‹
      if ('MediaRecorder' in window) {
        recBtn.disabled = false; recStopBtn.disabled = true;
        recHint.textContent = 'ä½¿ç”¨ MediaRecorder';
        let mediaRecorder = null; let chunks = [];
        recBtn.onclick = () => {
          try{
            mediaRecorder = new MediaRecorder(stream);
            chunks = [];
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
            mediaRecorder.onstop = () => {
              const blob = new Blob(chunks, {type: mediaRecorder.mimeType || 'audio/webm'});
              const url = URL.createObjectURL(blob);
              dl.href = url;
              const ts = new Date().toISOString().replace(/[:.]/g,'-');
              dl.download = `record-${ts}.webm`;
              dl.style.display = 'inline-block';
            };
            mediaRecorder.start();
            recBtn.disabled = true; recStopBtn.disabled = false; dl.style.display = 'none';
          }catch(err){ alert('å½•éŸ³å¯åŠ¨å¤±è´¥ï¼š' + (err.message || err)); }
        };
        recStopBtn.onclick = () => {
          if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            recBtn.disabled = false; recStopBtn.disabled = true;
          }
        };
      } else {
        recHint.textContent = 'å½“å‰ç¯å¢ƒä¸æ”¯æŒ MediaRecorderï¼ˆiOS è€ç‰ˆæœ¬å¸¸è§ï¼‰';
      }

    }catch(e){
      alert((e && e.message) ? e.message :
            'å¯åŠ¨å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœªæˆæƒéº¦å…‹é£ã€é HTTPSã€æˆ–æµè§ˆå™¨ä¸å…¼å®¹ã€‚');
      stop();
    }finally{
      toggleBtn.disabled = false;
    }
  }

  async function stop(){
    cancelAnimationFrame(raf); raf = null;
    try{ if (gainNode) gainNode.disconnect(); }catch(_){}
    try{ if (analyser) analyser.disconnect(); }catch(_){}
    try{ if (src) src.disconnect(); }catch(_){}
    try{ if (stream){ stream.getTracks().forEach(t=>t.stop()); } }catch(_){}
    try{ if (ac){ await ac.close(); } }catch(_){}
    ac = null; analyser = null; gainNode = null; src = null; stream = null;

    ctxState.textContent='AudioContext: â€”';
    toggleBtn.textContent='å¼€å§‹';
    recBtn.disabled = true; recStopBtn.disabled = true;
  }

  toggleBtn.addEventListener('click',()=>{ if(ac) stop(); else start(); });
  reenumBtn.addEventListener('click',enumerate);

  smoothingInp.addEventListener('input',()=>{
    const v = parseFloat(smoothingInp.value);
    smoothingVal.textContent = v.toFixed(2);
    if(analyser) analyser.smoothingTimeConstant = v;
  });
  gainInp.addEventListener('input',()=>{
    const v = parseFloat(gainInp.value);
    gainVal.textContent = v.toFixed(1);
    if(gainNode) gainNode.gain.value = v;
  });
  // æ–°å¢ï¼šæ³¢å½¢ç¼©æ”¾æ˜¾ç¤º
  scopeInp && scopeInp.addEventListener('input', () => {
    const v = parseFloat(scopeInp.value);
    scopeVal.textContent = v.toFixed(2) + 'Ã—';
  });
})();
</script>
</body>
</html>
